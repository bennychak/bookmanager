<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>初級班錄音教材</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 50px; }
        .audio-item { margin-bottom: 10px; }
        .nav-link { cursor: pointer; }
        .loader { text-align: center; margin-top: 50px; display: none; }
        @media (min-width: 768px) {
            .audio-row { display: flex; flex-wrap: wrap; }
            .audio-item { flex: 1 1 calc(50% - 20px); max-width: calc(50% - 20px); margin-right: 10px; margin-left: 10px; }
        }
        @media (min-width: 992px) {
            .audio-item { flex: 1 1 calc(33.333% - 20px); max-width: calc(33.333% - 20px); }
        }
        @media (min-width: 1200px) {
            .audio-item { flex: 1 1 calc(25% - 20px); max-width: calc(25% - 20px); }
        }
        audio { width: 100%; }
        .error-message { color: red; text-align: center; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">初級班錄音教材</h1>
        <ul class="nav nav-tabs" id="directoryNav">
            <!-- Navigation links will be inserted here -->
        </ul>

        <div id="content" class="mt-3">
            <div class="loader"><img src="data:image/gif;base64,R0lGODlhEAAQAPIAAP///wAAAMLCwkJCQgAAAGJiYoKCgpKSkiH/C05FVFNDQVBFMi4wAwEAAAAh/hpDcmVhdGVkIHdpdGggYWpheGxvYWQuaW5mbwAh+QQJCgAAACwAAAAAEAAQAAADMwi63P4wyklrE2MIOggZnAdOmGYJRbExwroUmcG2LmDEwnHQLVsYOd2mBzkYDAdKa+dIAAAh+QQJCgAAACwAAAAAEAAQAAADNAi63P5OjCEgG4QMu7DmikRxQlFUYDEZIGBMRVsaqHwctXXf7WEYB4Ag1xjihkMZsiUkKhIAIfkECQoAAAAsAAAAABAAEAAAAzYIujIjK8pByJDMlFYvBoVjHA70GU7xSUJhmKtwHPAKzLO9HMaoKwJZ7Rf8AYPDDzKpZBqfvwQAIfkECQoAAAAsAAAAABAAEAAAAzMIumIlK8oyhpHsnFZfhYumCYUhDAQxRIdhHBGqRoKw0R8DYlJd8z0fMDgsGo/IpHI5TAAAIfkECQoAAAAsAAAAABAAEAAAAzIIunInK0rnZBTwGPNMgQwmdsNgXGJUlIWEuR5oWUIpz8pAEAMe6TwfwyYsGo/IpFKSAAAh+QQJCgAAACwAAAAAEAAQAAADMwi6IMKQORfjdOe82p4wGccc4CEuQradylesojEMBgsUc2G7sDX3lQGBMLAJibufbSlKAAAh+QQJCgAAACwAAAAAEAAQAAADMgi63P7wCRHZnFVdmgRuQ Broadcom Corporation BCM43142 802.11b/g/n" alt="Loading..." /></div>
            <div class="error-message" id="errorMessage"></div>
            <!-- Audio items will be listed here -->
        </div>
    </div>

    <script>
        async function fetchDirectories() {
            try {
                const response = await fetch('audio-directory.json');
                if (!response.ok) throw new Error('Failed to fetch the JSON file.');
                return await response.json();
            } catch (error) {
                showError('无法加载录音教材，请稍后再试。');
                console.error(error);
                return null;
            }
        }

        function createNavigation(directories) {
            const nav = document.getElementById('directoryNav');
            function addDirectory(dir, parentDir = '') {
                for (const key in dir) {
                    if (typeof dir[key] === 'object' && !Array.isArray(dir[key])) {
                        // If the directory has subdirectories, iterate over them
                        addDirectory(dir[key], `${parentDir}${key}/`);
                    } else {
                        const li = document.createElement('li');
                        li.className = 'nav-item';
                        const a = document.createElement('a');
                        a.className = 'nav-link';
                        a.textContent = parentDir ? `${parentDir.replace(/\/$/, '')}` : key;
                        a.href = '#';
                        a.onclick = () => loadDirectory(parentDir ? `${parentDir.replace(/\/$/, '')}` : key);
                        li.appendChild(a);
                        nav.appendChild(li);
                    }
                }
            }
            addDirectory(directories);
        }

        function loadDirectory(directory) {
            const contentDiv = document.getElementById('content');
            const loader = contentDiv.querySelector('.loader');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.style.display = 'none';
            loader.style.display = 'block';
            contentDiv.innerHTML = ''; // Clear previous content

            fetchDirectories().then(directories => {
                if (!directories) return;

                let files;
                if (directory.includes('/')) {
                    const [mainDir, ...subDirs] = directory.split('/');
                    let currentDir = directories[mainDir];
                    for (let subDir of subDirs) {
                        if (currentDir[subDir]) {
                            currentDir = currentDir[subDir];
                        } else {
                            showError('指定的目录不存在。');
                            return;
                        }
                    }
                    files = currentDir;
                } else {
                    files = directories[directory];
                }

                if (files) {
                    files.forEach(filename => {
                        const div = document.createElement('div');
                        div.className = 'audio-item';

                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = './' + encodeURI(directory.replace(/\//g, '/') + '/' + filename);

                        const name = document.createElement('p');
                        name.textContent = filename;

                        audio.onplay = () => stopOtherAudios(audio);

                        div.appendChild(name);
                        div.appendChild(audio);
                        contentDiv.appendChild(div);
                    });
                } else {
                    showError('该目录下没有音频文件。');
                }
                loader.style.display = 'none';
            });
        }

        function stopOtherAudios(currentAudio) {
            document.querySelectorAll('audio').forEach(audio => {
                if (audio !== currentAudio && !audio.paused) {
                    audio.pause();
                    audio.currentTime = 0; // Reset to the start
                }
            });
        }

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        window.onload = () => {
            fetchDirectories().then(directories => {
                if (directories) {
                    createNavigation(directories);
                    loadDirectory(Object.keys(directories)[0]); // Load the first directory's content
                }
            });
        };
    </script>
</body>
</html>